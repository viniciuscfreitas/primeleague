package br.com.primeleague.combatlog.managers;

import br.com.primeleague.combatlog.CombatLogPlugin;
import br.com.primeleague.core.api.PrimeLeagueAPI;
import br.com.primeleague.admin.api.AdminAPI;
import br.com.primeleague.api.models.Punishment;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;

import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import java.util.logging.Logger;

/**
 * Servi√ßo de puni√ß√µes para combat log.
 * Integra com o AdminManager existente via PrimeLeagueAPI.
 * 
 * @author PrimeLeague Development Team
 * @version 1.0.0
 */
public class CombatPunishmentService {
    
    private final CombatLogPlugin plugin;
    private final Logger logger;
    
    // Cache de ocorr√™ncias por jogador (UUID -> contador)
    private final Map<UUID, Integer> playerOffenses = new HashMap<UUID, Integer>();
    
    // Configura√ß√µes de puni√ß√µes
    private int firstOffenseMinutes = 60;      // 1 hora
    private int secondOffenseMinutes = 360;    // 6 horas
    private int thirdOffenseMinutes = 1440;    // 24 horas
    private int chronicOffenseMinutes = -1;    // Permanente
    
    /**
     * Construtor do CombatPunishmentService.
     * 
     * @param plugin Inst√¢ncia do plugin principal
     */
    public CombatPunishmentService(CombatLogPlugin plugin) {
        this.plugin = plugin;
        this.logger = plugin.getLogger();
        
        // Carregar configura√ß√µes
        loadConfiguration();
        
        logger.info("‚úÖ CombatPunishmentService inicializado com sucesso!");
    }
    
    /**
     * Carrega as configura√ß√µes de puni√ß√µes do arquivo config.yml.
     */
    private void loadConfiguration() {
        try {
            firstOffenseMinutes = plugin.getConfig().getInt("combat_log.punishments.first_offense", 60);
            secondOffenseMinutes = plugin.getConfig().getInt("combat_log.punishments.second_offense", 360);
            thirdOffenseMinutes = plugin.getConfig().getInt("combat_log.punishments.third_offense", 1440);
            chronicOffenseMinutes = plugin.getConfig().getInt("combat_log.punishments.chronic_offense", -1);
            
            logger.info("‚úÖ Configura√ß√µes de puni√ß√µes carregadas - 1¬™: " + firstOffenseMinutes + 
                       "m, 2¬™: " + secondOffenseMinutes + "m, 3¬™: " + thirdOffenseMinutes + 
                       "m, Cr√¥nica: " + (chronicOffenseMinutes == -1 ? "Permanente" : chronicOffenseMinutes + "m"));
            
        } catch (Exception e) {
            logger.warning("‚ö†Ô∏è Erro ao carregar configura√ß√µes de puni√ß√µes, usando valores padr√£o: " + e.getMessage());
        }
    }
    
    /**
     * Aplica puni√ß√£o autom√°tica para combat log.
     * Integra com o AdminManager existente via PrimeLeagueAPI.
     * 
     * @param playerUuid UUID do jogador
     * @param playerName Nome do jogador
     */
    public void applyCombatLogPunishment(UUID playerUuid, String playerName) {
        if (playerUuid == null || playerName == null) {
            return;
        }
        
        try {
            // Incrementar contador de ocorr√™ncias
            int offenseCount = getOffenseCount(playerUuid) + 1;
            playerOffenses.put(playerUuid, offenseCount);
            
            // Determinar dura√ß√£o da puni√ß√£o
            int punishmentMinutes = getPunishmentDuration(offenseCount);
            String punishmentType = getPunishmentType(offenseCount);
            
            // Aplicar puni√ß√£o via AdminManager
            if (punishmentMinutes > 0) {
                applyTemporaryBan(playerUuid, playerName, punishmentMinutes, offenseCount);
            } else if (punishmentMinutes == -1) {
                applyPermanentBan(playerUuid, playerName, offenseCount);
            }
            
            // Log da puni√ß√£o aplicada
            logger.warning("üö® Puni√ß√£o aplicada para " + playerName + 
                          " - " + offenseCount + "¬™ ocorr√™ncia de combat log - " + punishmentType);
            
            // Notificar staff online
            notifyStaffAboutPunishment(playerName, offenseCount, punishmentType);
            
        } catch (Exception e) {
            logger.severe("‚ùå Erro ao aplicar puni√ß√£o para " + playerName + ": " + e.getMessage());
            e.printStackTrace();
        }
    }
    
    /**
     * Obt√©m o n√∫mero de ocorr√™ncias de um jogador.
     * 
     * @param playerUuid UUID do jogador
     * @return N√∫mero de ocorr√™ncias
     */
    private int getOffenseCount(UUID playerUuid) {
        Integer count = playerOffenses.get(playerUuid);
        return count != null ? count : 0;
    }
    
    /**
     * Determina a dura√ß√£o da puni√ß√£o baseada no n√∫mero de ocorr√™ncias.
     * 
     * @param offenseCount N√∫mero de ocorr√™ncias
     * @return Dura√ß√£o em minutos (-1 para permanente)
     */
    private int getPunishmentDuration(int offenseCount) {
        switch (offenseCount) {
            case 1:
                return firstOffenseMinutes;
            case 2:
                return secondOffenseMinutes;
            case 3:
                return thirdOffenseMinutes;
            default:
                return chronicOffenseMinutes;
        }
    }
    
    /**
     * Obt√©m o tipo de puni√ß√£o para exibi√ß√£o.
     * 
     * @param offenseCount N√∫mero de ocorr√™ncias
     * @return String descritiva da puni√ß√£o
     */
    private String getPunishmentType(int offenseCount) {
        switch (offenseCount) {
            case 1:
                return "Ban tempor√°rio de " + firstOffenseMinutes + " minutos";
            case 2:
                return "Ban tempor√°rio de " + secondOffenseMinutes + " minutos";
            case 3:
                return "Ban tempor√°rio de " + thirdOffenseMinutes + " minutos";
            default:
                return "Ban permanente";
        }
    }
    
    /**
     * Aplica ban tempor√°rio via AdminManager.
     * 
     * @param playerUuid UUID do jogador
     * @param playerName Nome do jogador
     * @param minutes Dura√ß√£o em minutos
     * @param offenseCount N√∫mero de ocorr√™ncias
     */
    private void applyTemporaryBan(UUID playerUuid, String playerName, int minutes, int offenseCount) {
        try {
            // Tentar usar o AdminManager via PrimeLeagueAPI
            if (AdminAPI.isAvailable()) {
                String reason = "Combat Log (" + offenseCount + "¬™ Ocorr√™ncia)";
                
                // Converter minutos para milissegundos
                long durationMillis = minutes * 60L * 1000L;
                
                // Aplicar ban tempor√°rio
                // Criar puni√ß√£o usando AdminAPI
                Punishment punishment = new Punishment();
                punishment.setTargetUuid(playerUuid);
                punishment.setTargetName(playerName);
                punishment.setType(Punishment.Type.BAN);
                punishment.setReason(reason);
                punishment.setExpiresAt(new java.sql.Timestamp(System.currentTimeMillis() + durationMillis));
                punishment.setAuthorUuid(null); // Sistema autom√°tico
                punishment.setAuthorName("PrimeLeague CombatLog");
                
                AdminAPI.applyPunishment(punishment);
                
                logger.info("‚úÖ Ban tempor√°rio aplicado via AdminManager para " + playerName + 
                           " por " + minutes + " minutos");
                
            } else {
                // Fallback: aplicar puni√ß√£o local
                applyLocalPunishment(playerUuid, playerName, minutes, offenseCount);
            }
            
        } catch (Exception e) {
            logger.warning("‚ö†Ô∏è Erro ao usar AdminManager, aplicando puni√ß√£o local: " + e.getMessage());
            applyLocalPunishment(playerUuid, playerName, minutes, offenseCount);
        }
    }
    
    /**
     * Aplica ban permanente via AdminManager.
     * 
     * @param playerUuid UUID do jogador
     * @param playerName Nome do jogador
     * @param offenseCount N√∫mero de ocorr√™ncias
     */
    private void applyPermanentBan(UUID playerUuid, String playerName, int offenseCount) {
        try {
            // Tentar usar o AdminManager via PrimeLeagueAPI
            if (AdminAPI.isAvailable()) {
                String reason = "Combat Log Cr√¥nico (" + offenseCount + "¬™ Ocorr√™ncia)";
                
                // Aplicar ban permanente
                // Criar puni√ß√£o permanente usando AdminAPI
                Punishment punishment = new Punishment();
                punishment.setTargetUuid(playerUuid);
                punishment.setTargetName(playerName);
                punishment.setType(Punishment.Type.BAN);
                punishment.setReason(reason);
                punishment.setExpiresAt(null); // Permanente
                punishment.setAuthorUuid(null); // Sistema autom√°tico
                punishment.setAuthorName("PrimeLeague CombatLog");
                
                AdminAPI.applyPunishment(punishment);
                
                logger.info("‚úÖ Ban permanente aplicado via AdminManager para " + playerName);
                
            } else {
                // Fallback: aplicar puni√ß√£o local
                applyLocalPunishment(playerUuid, playerName, -1, offenseCount);
            }
            
        } catch (Exception e) {
            logger.warning("‚ö†Ô∏è Erro ao usar AdminManager, aplicando puni√ß√£o local: " + e.getMessage());
            applyLocalPunishment(playerUuid, playerName, -1, offenseCount);
        }
    }
    
    /**
     * Aplica puni√ß√£o local como fallback.
     * 
     * @param playerUuid UUID do jogador
     * @param playerName Nome do jogador
     * @param minutes Dura√ß√£o em minutos (-1 para permanente)
     * @param offenseCount N√∫mero de ocorr√™ncias
     */
    private void applyLocalPunishment(UUID playerUuid, String playerName, int minutes, int offenseCount) {
        try {
            // Kickar o jogador se estiver online
            Player player = Bukkit.getPlayer(playerName);
            if (player != null && player.isOnline()) {
                String kickMessage = "üö® Voc√™ foi punido por combat log!\n" +
                                   "Ocorr√™ncia: " + offenseCount + "¬™\n" +
                                   "Puni√ß√£o: " + (minutes == -1 ? "Ban permanente" : "Ban de " + minutes + " minutos");
                
                player.kickPlayer(kickMessage);
            }
            
            // Nota: Ban local via Bukkit n√£o dispon√≠vel em 1.5.2
            // A puni√ß√£o ser√° aplicada via AdminManager que gerencia o ban no banco de dados
            
            logger.info("‚úÖ Puni√ß√£o local aplicada para " + playerName + 
                       " - " + offenseCount + "¬™ ocorr√™ncia");
            
        } catch (Exception e) {
            logger.severe("‚ùå Erro ao aplicar puni√ß√£o local para " + playerName + ": " + e.getMessage());
        }
    }
    
    /**
     * Notifica staff online sobre a puni√ß√£o aplicada.
     * 
     * @param playerName Nome do jogador punido
     * @param offenseCount N√∫mero de ocorr√™ncias
     * @param punishmentType Tipo de puni√ß√£o
     */
    private void notifyStaffAboutPunishment(String playerName, int offenseCount, String punishmentType) {
        try {
            String message = "üö® Puni√ß√£o aplicada: " + playerName + 
                           " - " + offenseCount + "¬™ ocorr√™ncia de combat log - " + punishmentType;
            
            // Notificar todos os jogadores com permiss√£o de staff
            for (Player player : Bukkit.getOnlinePlayers()) {
                if (player.hasPermission("primeleague.admin.combatlog")) {
                    player.sendMessage(message);
                }
            }
            
        } catch (Exception e) {
            logger.warning("‚ö†Ô∏è Erro ao notificar staff sobre puni√ß√£o: " + e.getMessage());
        }
    }
    
    /**
     * Obt√©m estat√≠sticas das puni√ß√µes.
     * 
     * @return String com estat√≠sticas
     */
    public String getPunishmentStats() {
        int totalPlayers = playerOffenses.size();
        int totalOffenses = 0;
        
        for (Integer count : playerOffenses.values()) {
            totalOffenses += count;
        }
        
        return String.format(
            "üìä Punishment Stats - Jogadores √∫nicos: %d, Total de ocorr√™ncias: %d",
            totalPlayers, totalOffenses
        );
    }
    
    /**
     * Remove uma ocorr√™ncia de um jogador (para staff).
     * 
     * @param playerUuid UUID do jogador
     * @return true se removido com sucesso
     */
    public boolean removeOffense(UUID playerUuid) {
        Integer removed = playerOffenses.remove(playerUuid);
        if (removed != null) {
            logger.info("‚úÖ Ocorr√™ncia removida para jogador " + playerUuid);
            return true;
        }
        return false;
    }
    
    /**
     * Recarrega as configura√ß√µes de puni√ß√µes.
     */
    public void reloadConfiguration() {
        loadConfiguration();
        logger.info("‚úÖ Configura√ß√µes de puni√ß√µes recarregadas!");
    }
}
